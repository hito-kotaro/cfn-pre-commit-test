#!/bin/bash

# 厳格なエラーチェック
set -e

echo "CloudFormationテンプレートのバリデーションを実行中..."

# 変更されたYAMLファイルを取得
YAML_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E 'template\.yaml$')

# テンプレートファイルが変更されていない場合は、固定のファイルをチェック
if [ -z "$YAML_FILES" ]; then
  echo "変更されたテンプレートファイルはありません。固定のテンプレートをチェックします。"
  YAML_FILES="template.yaml"
fi

# 各YAMLファイルに対してチェックを実行
for file in $YAML_FILES; do
  # ファイルが存在するか確認
  if [ ! -f "$file" ]; then
    echo "警告: ファイル '$file' が存在しません。スキップします。"
    continue
  fi

  echo "ファイルをチェック中: $file"
  
  # CloudFormation validate-templateでバリデーション
  echo "CloudFormation validate-templateを実行中..."
  aws cloudformation validate-template --template-body file://$file || exit 1
  
  # cfn-lintでチェック（W3002警告は無視）
  echo "cfn-lintを実行中..."
  cfn-lint -i W3002 -t $file || exit 1
  
  # Lambda関数のCodeUriパスをチェック
  echo "Lambda関数のCodeUriパスをチェック中..."
  
  # テンプレートファイルのディレクトリを取得
  TEMPLATE_DIR=$(dirname "$(realpath "$file")")
  
  # YAMLファイルからCodeUriを抽出（修正版）
  CODE_URIS=$(grep -E '^\s*CodeUri:' "$file" | sed -E 's/.*CodeUri:\s*(.*)/\1/' | tr -d ' ')
  
  if [ -z "$CODE_URIS" ]; then
    echo "警告: テンプレートファイル内にCodeUriプロパティが見つかりません"
    continue
  fi
  
  # 各CodeUriパスをチェック
  echo "$CODE_URIS" | while read -r CODE_URI; do
    # 空行をスキップ
    if [ -z "$CODE_URI" ]; then
      continue
    fi
    
    # 相対パスを絶対パスに変換
    if [[ "$CODE_URI" != /* ]]; then
      CODE_PATH="$TEMPLATE_DIR/$CODE_URI"
    else
      CODE_PATH="$CODE_URI"
    fi
    
    # パスが存在するかチェック
    if [ ! -e "$CODE_PATH" ]; then
      echo "エラー: CodeUri '$CODE_URI' が存在しません"
      exit 1
    else
      echo "成功: CodeUri '$CODE_URI' が存在します"
    fi
  done
done

echo "すべてのチェックが成功しました！"
exit 0 